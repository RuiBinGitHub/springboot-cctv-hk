<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.springboot.dao.GeomProjectDao">
	<insert id="insertGeomProject" parameterType="GeomProject" keyProperty="id" useGeneratedKeys="true">
		INSERT INTO geomproject VALUES(nextval('indexID'),
			#{extent},
			#{appertain},
			#{coveshape},
			#{covesize},
			#{sandshape},
			#{sanddeep},
			#{surveyer},
			#{project.id},
			null
		)
	</insert>
	
	<update id="updateGeomProject" parameterType="GeomProject">
		UPDATE geomproject SET extent=#{extent},
			appertain=#{appertain},
			coveshape=#{coveshape},
			covesize=#{covesize},
			sandshape=#{sandshape},
			sanddeep=#{sanddeep},
			surveyer=#{surveyer},
			projectid=#{project.id},
			<if test="extent == '' or extent == null">
				geom=null
			</if>
			<if test="extent != '' and extent != null">
				geom=ST_GeomFromText('polygon((${extent}))')
			</if>
		WHERE id=#{id}
	</update>
	
	<delete id="deleteGeomProject" parameterType="GeomProject">
		DELETE FROM geomproject WHERE id=#{id}
	</delete>
	
	<select id="findGeomProjectByID" parameterType="int" resultMap="GeomProjectMap">
		select * from geomproject where id = #{id}
	</select>
	
	<select id="findInfoGeomProject" parameterType="Map" resultMap="GeomProjectMap">
		select g.* from geomproject g left join project p on g.projectid=p.id
		<where>
			<if test="id != null">
				g.id = #{id}
			</if>
			<if test="project != null">
				and p.id = #{project.id}
			</if>
			<if test="person != null">
				and p.personid = #{person.id}
			</if>
			<if test="company != null">
				and p.companyid = #{company.id}
			</if>
		</where>
	</select>
	
	<select id="findListGeomProject" parameterType="Map" resultMap="GeomProjectMap">
		select g.* from geomproject g left join project p on g.projectid=p.id
		<where>
			<if test="option != null and value != null">
				${option} = #{value}
			</if>
			<if test="extent != null">
				and g.extent != ''
			</if>
			<if test="company != null">
				and p.companyid = #{company.id}
			</if>
		</where>
	</select>
	
	<resultMap id="GeomProjectMap" type="GeomProject">
		<id property="id" column="id"/>
		<result property="extent" column="extent"/>
		<result property="appertain" column="appertain"/>
		<result property="coveshape" column="coveshape"/>
		<result property="covesize" column="covesize"/>
		<result property="sandshape" column="sandshape"/>
		<result property="sanddeep" column="sanddeep"/>
		<result property="surveyer" column="surveyer"/>
		<association property="project" column="projectid" select="com.springboot.dao.ProjectDao.findProjectByID"/>
	</resultMap>
</mapper>
 